# 給与明細集計ツール - 簡易マニュアル（利用者向け）

## 🚀 使い方（基本フロー）

### ステップ 0️⃣: 初回設定（初めて使う場合のみ）

1. 「給与明細集計ツール」スプレッドシートをコピーして開く
   https://drive.google.com/drive/folders/1rAUZiYw_djySm3M0wecKPg1P8bTe0eJg

   原本をコピーしてクライアントの作業フォルダに移動させて利用ください。

2. 「設定」シートで以下を設定：
   - **Drive フォルダ ID**: 給与明細ファイルが入っている Google Drive フォルダの ID
   - **Cloud Functions URL**: 管理者から提供された URL（通常は既に設定済み）
3. メニューバー「給与明細集計」→「⚙️ ① 設定」をクリックして設定を確認
   - **初回利用時のみ**: 「承認が必要です」または「Google にログイン」画面が表示されます
   - 以下の権限を許可してください：
     - **Google ドライブ**: ファイルの表示、編集、作成、削除
     - **Google スプレッドシート**: スプレッドシートの参照、編集、作成、削除
     - **外部サービスへの接続**: Cloud Functions への接続
   - 「すべて選択」にチェックを入れて「許可」をクリック
   - この認証は初回のみで、2 回目以降は不要です

### ステップ 1️⃣: ファイルをアップロード

1. Google Drive の指定フォルダを開く
2. 給与明細 Excel ファイルをドラッグ&ドロップ

### ステップ 2️⃣: ファイル名の確認・変更（推奨）

#### ② ファイル名を読み込み

1. メニューバー「給与明細集計」→「📂 ② ファイル名を読み込み」をクリック
2. 「設定」シートに以下が表示されます：
   - A 列（A6 以降）: 現在のファイル名
   - B 列（B6 以降）: 推奨形式のファイル名（自動生成）
   - A 列のファイル名を読み込むと同時に、B 列に推奨形式のファイル名が仮でセットされます
   - この推奨形式は、ファイル名に含まれる日付情報から自動生成されます

#### B 列の確認と編集

3. **B 列を確認し、必要に応じて手動で編集してください**
   - 自動生成された推奨形式が正しくない場合や、`YYYYMM_支給控除一覧表` のような形式の場合、B 列を直接編集して正しいファイル名を入力してください
   - B 列には必ず `YYYYMMDD` 形式の日付（8 桁の数字）と、給与か賞与かの情報を含むファイル名を入力する必要があります
   - 例: `202501_支給控除一覧表.xlsx` → B 列に `給与明細_20250131.xlsx` と入力

**推奨ファイル名形式:**

- 給与: `給与明細_YYYYMMDD.xlsx` または `給与_YYYYMMDD.xlsx`
- 賞与: `賞与明細_YYYYMMDD.xlsx` または `賞与_YYYYMMDD.xlsx`

#### ③ ファイル名を変更

4. 「✏️ ③ ファイル名を変更」をクリックして、ファイル名を変更
   - **A 列のファイル名を B 列に設定したファイル名に変更します**
   - B 列が空の行はスキップされます（変更前に警告が表示されます）
   - 変更前に確認ダイアログが表示されます
   - この操作は取り消せません（必要に応じて Google Drive の履歴から復元可能）
   - 標準形式に変更すると、支給日の抽出が正確になります

**重要:**

- 「② ファイル名を読み込み」を実行した後、B 列に正しいファイル名が入力されていることを確認してください
- B 列が空の場合は、そのファイルは変更されません

### ステップ 3️⃣: 集計実行

1. メニューバー「給与明細集計」→「📊 ④ 集計開始」をクリック
2. 確認ダイアログで「OK」をクリック
3. 処理完了のメッセージが表示されるまで待機（1-2 分程度）

**注意事項:**

- 処理には数分かかる場合があります（10 ファイル: 約 30 秒、50 ファイル: 約 2 分、100 ファイル: 約 4 分）
- 処理中は他の操作を行わないでください
- 既存の「集計結果」シートと「月別集計」シートは上書きされます

### ステップ 4️⃣: 結果を確認

1. 以下のシートに結果が出力されます：
   - **「集計結果」シート**: 従業員別の明細データ
   - **「月別集計」シート**: 月別・給与・賞与区分ごとの集計データ
2. 必要に応じて Excel にコピー、または CSV でダウンロード

### ステップ 5️⃣: 入退職者チェック（オプション）

1. メニューバー「給与明細集計」→「✅ ⑤ 入退職者チェック作成」をクリック
2. 「入退職者チェック」シートが作成され、以下が自動設定されます：
   - 従業員ごとの月別課税支給額（1 月〜12 月）
   - 年間合計
   - 退職日（P 列）: 途中退職者の最終支給月の月末日
   - 入社日（Q 列）: 途中入社者の支給開始月の 1 日

**注意事項:**

- 「集計結果」シートが存在しない場合はエラーになります
- 先に「④ 集計開始」を実行している必要があります

---

## 📋 出力されるシートと列

### 「集計結果」シート

従業員別の明細データが出力されます。

| 列  | 内容                             |
| --- | -------------------------------- |
| A   | 空欄                             |
| B   | 従業員番号                       |
| C   | 氏名                             |
| D   | 支給月（1-12 の数字）            |
| E   | 支給日（西暦/月/日）             |
| F   | 給与・賞与区分（1=給与、2=賞与） |
| G   | 課税支給額                       |
| H   | 非課税支給額                     |
| I   | 健康保険料+介護保険料            |
| J   | 厚生年金保険料                   |
| K   | 雇用保険料                       |
| L   | 空欄                             |
| M   | 源泉所得税額                     |

### 「月別集計」シート

月別・給与・賞与区分ごとの集計データが出力されます。

| 列  | 内容                        |
| --- | --------------------------- |
| A   | 支給月（1-12 の数字）       |
| B   | 給与・賞与区分（給与/賞与） |
| C   | 従業員数                    |
| D   | 課税支給額                  |
| E   | 非課税支給額                |
| F   | 支給合計                    |
| G   | 健保+介護                   |
| H   | 厚生年金                    |
| I   | 雇用保険                    |
| J   | 源泉所得税                  |
| K   | 控除合計                    |
| L   | 差引支給額                  |

### 「入退職者チェック」シート

従業員ごとの月別課税支給額と入退職日付が出力されます。

| 列  | 内容                 |
| --- | -------------------- |
| A   | 従業員番号           |
| B   | 氏名                 |
| C   | 1 月                 |
| D   | 2 月                 |
| E   | 3 月                 |
| F   | 4 月                 |
| G   | 5 月                 |
| H   | 6 月                 |
| I   | 7 月                 |
| J   | 8 月                 |
| K   | 9 月                 |
| L   | 10 月                |
| M   | 11 月                |
| N   | 12 月                |
| O   | 年間合計             |
| P   | 退職日（自動設定）   |
| Q   | 入社日（自動設定）   |
| R   | 備考（手動入力可能） |

**日付の自動設定ルール:**

- **退職日（P 列）**: 12 月まで支給がない場合、最終支給月の月末日が自動設定されます
- **入社日（Q 列）**: 1 月に支給がない場合、支給開始月の 1 日が自動設定されます
- 1 月〜12 月まで支給がある場合は、日付は空欄のままです

---

## ⚠️ 注意事項

### 対応ファイル形式

- ✅ Excel 形式（.xlsx、.xls）
- ✅ 給与明細一覧表
- ✅ 賞与明細一覧表

### 処理時間の目安

- 10 ファイル: 約 30 秒
- 50 ファイル: 約 2 分
- 100 ファイル: 約 4 分

### ファイル名のルール

**重要:** ファイル名を変更する場合は、以下の形式を維持してください。

#### 支給日の抽出

- ファイル名に**8 桁の数字（YYYYMMDD 形式）**を含めると、支給日が自動抽出されます
- 例: `給与明細_20250131.xlsx` → 支給日: 2025/01/31
- 例: `給与_20250831.xlsx` → 支給日: 2025/08/31

#### 支給月の抽出

- 支給日から自動的に月が抽出されます（支給日が 2025/01/31 の場合、支給月は 1）
- 支給日が取得できない場合、`YYYY.M` または `YYYY.MM` 形式からも抽出可能
- 例: `給与_2025.1.xlsx` → 支給月: 1

#### 賞与ファイルの判定

- ファイル名に**「賞与」または「bonus」**が含まれていると、賞与ファイルとして処理されます
- 例: `賞与明細_20250131.xlsx` → 賞与として処理
- 例: `bonus_20250131.xlsx` → 賞与として処理
- それ以外は給与として処理されます

#### 推奨ファイル名形式

- 給与: `給与明細_20250131.xlsx` または `給与_20250131.xlsx`
- 賞与: `賞与明細_20250131.xlsx` または `賞与_20250131.xlsx`

**注意:** ファイル名に 8 桁の数字が含まれていない場合、支給日が空欄になる可能性があります。

---

## 🔧 トラブルシューティング

### Q1: 「ファイルが見つかりません」と表示される

**A:** 以下を確認してください:

- Google Drive の指定フォルダに Excel ファイルがアップロードされているか
- 「設定」シートの Drive フォルダ ID が正しく設定されているか
- フォルダへのアクセス権限があるか

### Q2: 「Drive フォルダ ID が設定されていません」と表示される

**A:** 「設定」シートの B2 セルに Google Drive フォルダの ID を入力してください。フォルダ ID の確認方法は「よくある質問」を参照してください。

### Q3: 処理が途中で止まる

**A:** ファイル数が多すぎる可能性があります。50 ファイルずつに分けて処理してください。

### Q4: 結果の金額がおかしい

**A:** 元の Excel ファイルのフォーマットを確認してください。フォーマットが大きく異なる場合は管理者に連絡してください。

### Q5: 「入退職者チェック」シートが作成できない

**A:** 以下を確認してください:

- 「集計結果」シートが存在するか
- 「集計結果」シートにデータが含まれているか
- 先に「④ 集計開始」を実行しているか

### Q6: ファイル名を変更できない

**A:** 以下を確認してください:

- Google Drive のフォルダへの編集権限があるか
- ファイルが他のユーザーによって開かれていないか
- 「設定」シートの Drive フォルダ ID が正しく設定されているか

### Q7: エラーメッセージが表示される

**A:** エラーメッセージをスクリーンショットして管理者に連絡してください。

---

## 📞 問い合わせ先

技術的な問題が発生した場合:

- 管理者: [担当者名]
- メール: [メールアドレス]
- 内線: [内線番号]

---

## 💾 結果のダウンロード方法

### Excel ファイルとしてダウンロード

1. ダウンロードしたいシート（「集計結果」「月別集計」「入退職者チェック」など）を選択
2. 「ファイル」→「ダウンロード」→「Microsoft Excel (.xlsx)」

### CSV ファイルとしてダウンロード

1. ダウンロードしたいシートを選択
2. 「ファイル」→「ダウンロード」→「カンマ区切り形式 (.csv)」

### 他のシートにコピー

1. 結果の範囲を選択（Ctrl+A で全選択）
2. コピー（Ctrl+C）
3. 別のスプレッドシートや Excel に貼り付け（Ctrl+V）

### シートをコピーして保存

1. 保存したいシートのタブを右クリック
2. 「コピーを作成」を選択
3. コピーされたシートの名前を変更して保存

---

## 🎯 よくある質問

### Q: 処理済みのファイルはどうすればいい?

A: 別フォルダに移動するか、ファイル名に「\_処理済」などを追加して管理することをお勧めします。

### Q: 同じファイルを複数回処理したらどうなる?

A: 問題ありません。同じデータが重複して出力されるだけです。既存の「集計結果」シートと「月別集計」シートは上書きされます。

### Q: 複数人で同時に使える?

A: はい。ただし、同じスプレッドシートを複数人が同時に使うと結果が上書きされます。各自がスプレッドシートのコピーを作成することをお勧めします。

### Q: 過去の結果を保存したい

A: 各シートを右クリック →「コピーを作成」で別シートに保存できます。または、ファイルごとダウンロードして保存してください。

### Q: ファイル名を変更しなくても集計できる?

A: はい、できます。ただし、ファイル名に日付情報が含まれていない場合、支給日が空欄になる可能性があります。正確な支給日を取得するため、ファイル名の変更をお勧めします。

### Q: 「入退職者チェック」シートの日付が正しくない

A: 日付は「集計結果」シートの支給月データから自動計算されます。「集計結果」シートの支給月が正しく設定されているか確認してください。

### Q: 「設定」シートの Drive フォルダ ID はどこで確認できる?

A: Google Drive でフォルダを開き、URL の `folders/` の後ろの文字列がフォルダ ID です。例: `https://drive.google.com/drive/folders/1a2b3c4d5e6f7g8h9i0j` の場合、`1a2b3c4d5e6f7g8h9i0j` がフォルダ ID です。

---

## 📚 参考: 初回利用時のみ必要な設定

### 権限許可（初回のみ）

初めて使う場合、ステップ 0️⃣ の 2 で「⚙️ ① 設定」をクリックした際に、以下の権限許可が必要です（1 回のみ）:

- **Google ドライブ**: ファイルの表示、編集、作成、削除
- **Google スプレッドシート**: スプレッドシートの参照、編集、作成、削除
- **外部サービスへの接続**: Cloud Functions への接続

「すべて選択」にチェックを入れて「許可」をクリックしてください。この認証は初回のみで、2 回目以降は不要です。

### 「設定」シートの作成

「設定」シートは、スプレッドシートを開いた時に自動的に作成されます。手動で作成する必要はありません。

「設定」シートには以下の情報が表示されます:

- **Drive フォルダ ID**: B2 セルに設定
- **Cloud Functions URL**: B3 セルに設定
- **ファイル名一覧**: A6 以降に表示（「② ファイル名を読み込み」実行後）

---

更新日: 2025 年 11 月 10 日
バージョン: 2.0
