# v5.0 標準テーブル形式対応

## 🎯 新機能

- **標準テーブル形式（一般的なExcel表形式）に対応**
- **CSV（カンマ/タブ区切り）の自動読込と文字コード自動判定**
- **項目名の別名・括弧表記の正規化を強化**

---

## 📊 対応する3つのレイアウト

### 1. 縦型レイアウト（v1から対応）

```
┌──────┬──────┬──────┬──────┐
│項目名│田中  │佐藤  │鈴木  │
├──────┼──────┼──────┼──────┤
│課税支給合計│250000│280000│300000│
```

**特徴:**
- 1列目に項目名
- 2列目以降に従業員データ

---

### 2. 横型レイアウト（v4から対応）

```
┌──────────┬──────┬──────┬──────┐
│従業員番号  │101   │102   │103   │
├──────────┼──────┼──────┼──────┤
│氏名       │田中  │佐藤  │鈴木  │
├──────────┼──────┼──────┼──────┤
│課税支給合計│250000│280000│300000│
```

**特徴:**
- 1列目に項目名
- 2列目以降に従業員データ

---

### 3. 標準テーブル形式（v5で新規対応）✨

```
┌────────┬────┬────────┬──────┬────────┐
│従業員番号│従業員│出勤日数│...│課税支給合計│
├────────┼────┼────────┼──────┼────────┤
│1       │田中 │20      │...│250000  │
├────────┼────┼────────┼──────┼────────┤
│2       │佐藤 │22      │...│280000  │
```

**特徴:**
- **1行目に項目名**
- **2行目以降に従業員データ**
- 最も一般的なExcel表形式

---

## 🔍 レイアウト自動判定

システムが自動で判定します:

```python
# 判定ロジック
1. 1行目に「従業員番号」と「従業員（氏名系）」の両方があれば → 標準テーブル形式
2. 1列目に「従業員番号」「従業員（氏名系）」のいずれかが出現すれば → 横型
3. 先頭セルが「項目名」の場合、または上記に該当しない場合 → 縦型
```

- 標準テーブル形式ではヘッダー行から列マッピングを生成し、2行目以降を従業員レコードとして処理します。
- 横型/縦型では1列目を項目リストとみなし、従業員ごとの値は列方向に展開されます。
- 集計対象がすべてゼロの列（従業員）は自動的にスキップされます。

---

## 📄 ファイル名からの自動判断

- `YYYYMMDD` 形式の8桁日付を検出すると、支給日 (`payment_date`) と支給月 (`payment_month`) を自動設定します。
- ファイル名に `賞与` または `bonus` が含まれている場合は賞与 (`salary_bonus_flag = 2`)、それ以外は給与 (`salary_bonus_flag = 1`) として扱います。
- 支給月は支給日からの推定値が優先され、未検出の場合はファイル名から抽出した月を使用します。

---

## ✅ 動作確認

### テストファイル: `給与明細_20250131.xlsx`

```
処理結果: 8名

1. 廣瀬好伸
   従業員番号: 1
   支給月: 1月
   課税支給額: 1,700,000円
   非課税支給額: 0円
   健保+介護: 71,370円
   厚生年金: 52,742円
   雇用保険: 0円
   所得税: 325,890円

2. 林賢太郎
   従業員番号: 2
   支給月: 1月
   課税支給額: 950,000円
   ...
```

**✅ 正しく処理されました!**

---

## 📋 必要な列

標準テーブル形式で必要な列:

### 必須項目

| 列名 | 別名候補 |
|------|---------|
| 従業員番号 | 社員番号、ID |
| 従業員 | 氏名、従業員名、社員名 |
| 課税支給合計 | 課税支給額合計 |

### オプション項目

| 列名 | 別名候補 |
|------|---------|
| 非課税支給合計 | 非税支給合計、非課税支給額合計 |
| 健康保険料 | 健保、健康保険料(控除) |
| 介護保険料 | 介護、介護保険料(控除) |
| 厚生年金保険料 | 厚生年金保険、厚生年金、厚生年金保険料(控除)、厚年 |
| 雇用保険料 | 雇保、雇用保険料(控除) |
| 所得税 | 所得税(控除) |

---

## 🎯 項目名の柔軟な認識

システムは複数のパターンを自動認識:

```python
# 例: 括弧付きの項目名
「健康保険料(控除)」→「健康保険料」として認識 ✅
「所得税(控除)」→「所得税」として認識 ✅
```

---

## 🚀 デプロイ

### Cloud Run functions

1. Google Cloud Console → Cloud Run
2. 関数を編集
3. `main.py`を v5.0に更新（CSV対応・3レイアウト自動判定を含む最新版）
4. デプロイ

**所要時間: 3分**

---

## 💡 v5.0の改善点

| 項目 | v4.x | v5.0 |
|------|------|------|
| 対応レイアウト | 縦型、横型 | 縦型、横型、標準テーブル ✨ |
| レイアウト判定 | 2パターン | 3パターン |
| 一般的なExcel対応 | ❌ | ✅ |
| 項目名の括弧対応 | ❌ | ✅ |

---

## 📝 まとめ

### v5.0で追加された機能

- ✅ 標準テーブル形式（1行目に項目名、2行目以降に従業員データ）に対応
- ✅ CSVアップロードを自動判定（カンマ/タブ・主要文字コードをサポート）
- ✅ 項目名の括弧（控除、支給など）を自動除去
- ✅ 柔軟な項目名認識（複数の別名に対応）
- ✅ 最も一般的なExcel表形式に対応

### すべての対応形式

1. ✅ 縦型レイアウト
2. ✅ 横型レイアウト
3. ✅ 標準テーブル形式 ← NEW!

---

更新日: 2025年11月11日
バージョン: 5.0
